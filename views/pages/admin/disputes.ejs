<!-- views/pages/admin/disputes.ejs -->
<div class="max-w-7xl mx-auto p-6">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-bold text-red-700 flex items-center gap-2">‚öñÔ∏è Open Disputes</h2>
    <a href="/admin/disputes-history" class="text-sm text-blue-600 hover:underline">üìú View History</a>
  </div>

  <div id="alertBox" class="hidden mb-4 p-3 rounded text-white text-center"></div>

  <% if (disputes && disputes.length) { %>
    <div class="overflow-x-auto bg-white rounded-xl shadow">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50 text-gray-700">
          <tr>
            <th class="p-3 text-left">Dispute ID</th>
            <th class="p-3 text-left">Milestone</th>
            <th class="p-3 text-left">Raised By</th>
            <th class="p-3 text-left">Reason</th>
            <th class="p-3 text-center">Status</th>
            <th class="p-3 text-center">Created</th>
            <th class="p-3 text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% disputes.forEach(d => { %>
            <tr id="row-<%= d._id %>" class="border-t hover:bg-gray-50">
              <td class="p-3 font-mono"><%= d._id %></td>
              <td class="p-3"><%= d.milestone?.title || ('Milestone #' + d.milestone?._id) %></td>
              <td class="p-3"><%= d.raisedBy?.fullName || d.raisedBy?.email || 'User' %></td>
              <td class="p-3 max-w-xs"><div class="line-clamp-2"><%= d.reason %></div></td>
              <td class="p-3 text-center">
                <span class="px-2 py-1 rounded-full text-xs font-semibold <%= d.status === 'open' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700' %>">
                  <%= d.status %>
                </span>
              </td>
              <td class="p-3 text-center"><%= new Date(d.createdAt).toLocaleString() %></td>
              <td class="p-3 text-center">
                <% if (d.status === 'open') { %>
                  <button onclick="resolveDispute('<%= d._id %>')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs">
                    ‚úÖ Resolve
                  </button>
                <% } else { %>
                  <span class="text-gray-400 text-xs italic">Resolved</span>
                <% } %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } else { %>
    <div class="bg-white rounded-xl shadow p-10 text-center text-gray-600">No open disputes.</div>
  <% } %>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
async function resolveDispute(disputeId) {
  const { value: resolution } = await Swal.fire({
    title: "Resolve Dispute",
    input: "textarea",
    inputPlaceholder: "Write the admin decision / notes...",
    showCancelButton: true,
    confirmButtonText: "‚úÖ Resolve",
  });
  if (resolution === undefined) return;

  const res = await fetch("/admin/disputes/resolve", {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ disputeId, resolution })
  });
  const data = await res.json();

  if (data.success) {
    Swal.fire("Resolved!", data.message || "Dispute resolved.", "success");
    const row = document.getElementById(`row-${disputeId}`);
    if (row) row.querySelector("span").className = "px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700";
    if (row) row.querySelector("span").textContent = "resolved";
  } else {
    Swal.fire("Error", data.message || "Failed to resolve dispute.", "error");
  }
}
</script>
