<!-- views/pages/admin/dispute-history.ejs -->
<div class="max-w-7xl mx-auto p-6">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">ğŸ“œ Dispute History</h2>
    <a href="/admin/disputes" class="text-sm text-blue-600 hover:underline">â†©ï¸ Back to Open Disputes</a>
  </div>

  <div class="bg-white rounded-xl shadow p-4 mb-4 flex items-center gap-3">
    <label class="text-sm text-gray-600">Filter by status:</label>
    <select id="statusFilter" class="border rounded px-3 py-2 text-sm">
      <option value="">All</option>
      <option value="open">Open</option>
      <option value="resolved">Resolved</option>
      <option value="closed">Closed</option>
    </select>
  </div>

  <% if (disputes && disputes.length) { %>
    <div class="overflow-x-auto bg-white rounded-xl shadow">
      <table id="historyTable" class="min-w-full text-sm">
        <thead class="bg-gray-50 text-gray-700">
          <tr>
            <th class="p-3 text-left">Dispute</th>
            <th class="p-3 text-left">Milestone</th>
            <th class="p-3 text-left">Raised By</th>
            <th class="p-3 text-left">Reason</th>
            <th class="p-3 text-center">Status</th>
            <th class="p-3 text-left">Resolution</th>
            <th class="p-3 text-center">Updated</th>
          </tr>
        </thead>
        <tbody>
          <% disputes.forEach(d => { %>
            <tr class="border-t hover:bg-gray-50" data-status="<%= d.status %>">
              <td class="p-3 font-mono"><%= d._id %></td>
              <td class="p-3"><%= d.milestone?.title || ('Milestone #' + d.milestone?._id) %></td>
              <td class="p-3"><%= d.raisedBy?.fullName || d.raisedBy?.email || 'User' %></td>
              <td class="p-3"><div class="line-clamp-2 max-w-xs"><%= d.reason %></div></td>
              <td class="p-3 text-center">
                <span class="px-2 py-1 rounded-full text-xs font-semibold
                <%= d.status === 'open' ? 'bg-red-100 text-red-700' :
                    d.status === 'resolved' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700' %>">
                  <%= d.status %>
                </span>
              </td>
              <td class="p-3"><div class="line-clamp-2 max-w-xs"><%= d.resolution || '-' %></div></td>
              <td class="p-3 text-center"><%= new Date(d.updatedAt || d.createdAt).toLocaleString() %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } else { %>
    <div class="bg-white rounded-xl shadow p-10 text-center text-gray-600">No dispute history.</div>
  <% } %>
</div>

<script>
document.getElementById('statusFilter')?.addEventListener('change', (e) => {
  const val = e.target.value;
  document.querySelectorAll('#historyTable tbody tr').forEach(tr => {
    if (!val) { tr.classList.remove('hidden'); return; }
    tr.dataset.status === val ? tr.classList.remove('hidden') : tr.classList.add('hidden');
  });
});
</script>
