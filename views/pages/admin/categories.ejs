<!-- ‚úÖ views/pages/admin/categories.ejs -->
<div class="container mx-auto p-6">
  <h2 class="text-2xl font-bold text-blue-600 mb-6">Category Management</h2>

  <% if (success && success.length) { %>
    <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-3 mb-4 rounded">
      <%= success[0] %>
    </div>
  <% } %>

  <% if (error && error.length) { %>
    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-3 mb-4 rounded">
      <%= error[0] %>
    </div>
  <% } %>

  <!-- ‚ûï Add New Category -->
  <form action="/admin/categories/create" method="POST" class="flex flex-wrap gap-2 mb-6">
    <input type="text" name="name" placeholder="Category Name" required
      class="border rounded p-2 flex-grow" />
    <input type="text" name="description" placeholder="Description"
      class="border rounded p-2 flex-grow" />
    <button type="submit"
      class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Add</button>
  </form>

  <!-- üìã Category Table -->
  <div class="overflow-x-auto shadow rounded-lg">
    <table class="w-full border-collapse border text-sm md:text-base">
      <thead class="bg-gray-100">
        <tr>
          <th class="border p-2 text-left">Category</th>
          <th class="border p-2 text-left">Status</th>
          <th class="border p-2 text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if (!categories || categories.length === 0) { %>
          <tr>
            <td colspan="3" class="text-center text-gray-500 py-4">
              No categories found.
            </td>
          </tr>
        <% } else { %>
          <% categories.forEach(cat => { %>
            <tr class="border-b hover:bg-gray-50 transition">
              <td class="p-2 font-semibold cursor-pointer text-blue-600"
                onclick="toggleSubcategories('<%= cat._id %>')">
                <%= cat.name %>
              </td>
              <td class="p-2">
                <span class="<%= cat.isApproved ? 'text-green-600' : 'text-yellow-600' %> font-semibold">
                  <%= cat.isApproved ? '‚úÖ Approved' : '‚è≥ Pending' %>
                </span>
              </td>
              <td class="p-2 text-center space-x-1">
                <!-- üü¢ Approve / üî¥ Not Approve Buttons -->
                <% if (!cat.isApproved) { %>
                  <button onclick="approveCategory('<%= cat._id %>')"
                    class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded">Approve</button>
                <% } else { %>
                  <button onclick="notApproveCategory('<%= cat._id %>')"
                    class="bg-yellow-600 hover:bg-yellow-700 text-white px-2 py-1 rounded">Not Approve</button>
                <% } %>

                <!-- ‚úèÔ∏è Edit Button -->
                <button onclick="editCategory('<%= cat._id %>', '<%= cat.name %>')"
                  class="bg-indigo-500 hover:bg-indigo-600 text-white px-2 py-1 rounded">Edit</button>

                <!-- üóëÔ∏è Delete Button -->
                <form action="/admin/categories/delete/<%= cat._id %>" method="POST" class="inline">
                  <button type="submit"
                    onclick="return confirm('Are you sure you want to delete this category?')"
                    class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded">Delete</button>
                </form>
              </td>
            </tr>

            <!-- üîΩ Expandable Subcategory Row -->
            <tr id="subs-<%= cat._id %>" class="hidden bg-gray-50">
              <td colspan="3" class="p-4">
                <div id="subcontainer-<%= cat._id %>" class="text-sm text-gray-700">Loading...</div>

                <!-- Add Subcategory -->
                <div class="mt-3 flex gap-2">
                  <input id="new-sub-<%= cat._id %>" type="text"
                    placeholder="Add subcategory..."
                    class="border rounded p-2 flex-grow" />
                  <button onclick="addSubcategory('<%= cat._id %>')"
                    class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">
                    Add
                  </button>
                </div>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<!-- ‚úÖ SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // üîΩ Expand/Collapse Subcategories
  async function toggleSubcategories(catId) {
    const row = document.getElementById(`subs-${catId}`);
    const container = document.getElementById(`subcontainer-${catId}`);

    if (!row.classList.contains("hidden")) {
      row.classList.add("hidden");
      return;
    }

    row.classList.remove("hidden");
    container.innerHTML = "<p>Loading...</p>";

    try {
      const res = await fetch(`/admin/categories/${catId}/subcategories`);
      const data = await res.json();

      if (!data.success) {
        container.innerHTML = `<p class="text-red-500">${data.message}</p>`;
        return;
      }

      if (!data.subcategories.length) {
        container.innerHTML = "<p class='text-gray-500 italic'>No subcategories yet.</p>";
        return;
      }

      container.innerHTML = `
        <ul class='list-disc ml-5 space-y-1'>
          ${data.subcategories.map(sub => `
            <li>
              <span>${sub.name}</span>
              ${sub.isApproved ? "‚úÖ" : "‚è≥"}
              <button onclick="approveSubcategory('${catId}', '${sub._id}')"
                class="text-green-600 ml-2 hover:underline">Approve</button>
              <button onclick="editSubcategory('${catId}', '${sub._id}', '${sub.name}')"
                class="text-indigo-600 ml-2 hover:underline">Edit</button>
              <button onclick="deleteSubcategory('${catId}', '${sub._id}')"
                class="text-red-600 ml-2 hover:underline">Delete</button>
            </li>
          `).join("")}
        </ul>
      `;
    } catch (err) {
      container.innerHTML = `<p class="text-red-500">Error loading subcategories.</p>`;
    }
  }

  // ‚ûï Add Subcategory
  async function addSubcategory(catId) {
    const name = document.getElementById(`new-sub-${catId}`).value.trim();
    if (!name) return Swal.fire("Error", "Please enter a subcategory name.", "error");

    const res = await fetch(`/admin/categories/${catId}/subcategories`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name }),
    });

    const data = await res.json();
    if (data.success) {
      Swal.fire("Added!", data.message, "success");
      document.getElementById(`new-sub-${catId}`).value = "";
      toggleSubcategories(catId);
    } else {
      Swal.fire("Error", data.message || "Something went wrong.", "error");
    }
  }

  // ‚úÖ Approve Category
  async function approveCategory(catId) {
    const res = await fetch(`/admin/categories/approve/${catId}`, { method: "POST" });
    const data = await res.json();

    if (data.success) {
      Swal.fire("Approved!", data.message, "success").then(() => window.location.reload());
    } else {
      Swal.fire("Error", data.message || "Approval failed.", "error");
    }
  }

  // ‚ùå Not Approve (Revoke Approval)
  async function notApproveCategory(catId) {
    const confirm = await Swal.fire({
      title: "Revoke approval?",
      text: "This category will be marked as not approved.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Yes, revoke it",
      confirmButtonColor: "#d33",
    });

    if (!confirm.isConfirmed) return;

    const res = await fetch(`/admin/categories/not-approve/${catId}`, { method: "POST" });
    const data = await res.json();

    if (data.success) {
      Swal.fire("Updated!", data.message, "success").then(() => window.location.reload());
    } else {
      Swal.fire("Error", data.message || "Update failed.", "error");
    }
  }

  // ‚úèÔ∏è Edit Category
  async function editCategory(catId, oldName) {
    const { value: newName } = await Swal.fire({
      title: "Edit Category",
      input: "text",
      inputLabel: "Enter new category name",
      inputValue: oldName,
      showCancelButton: true,
      confirmButtonText: "Update",
    });

    if (!newName || newName === oldName) return;

    const res = await fetch(`/admin/categories/update/${catId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name: newName }),
    });

    const data = await res.json();
    if (data.success) {
      Swal.fire("Updated!", data.message, "success").then(() => window.location.reload());
    } else {
      Swal.fire("Error", data.message || "Update failed.", "error");
    }
  }

  // ‚úèÔ∏è Edit Subcategory
  async function editSubcategory(catId, subId, oldName) {
    const { value: newName } = await Swal.fire({
      title: "Edit Subcategory",
      input: "text",
      inputLabel: "Enter new subcategory name",
      inputValue: oldName,
      showCancelButton: true,
      confirmButtonText: "Update",
    });

    if (!newName || newName === oldName) return;

    const res = await fetch(`/admin/categories/${catId}/subcategories/update/${subId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name: newName }),
    });

    const data = await res.json();
    if (data.success) {
      Swal.fire("Updated!", data.message, "success");
      toggleSubcategories(catId);
    } else {
      Swal.fire("Error", data.message || "Update failed.", "error");
    }
  }

  // ‚úÖ Approve Subcategory
  async function approveSubcategory(catId, subId) {
    const res = await fetch(`/admin/categories/${catId}/subcategories/approve/${subId}`, {
      method: "POST",
    });
    const data = await res.json();

    if (data.success) {
      Swal.fire("Approved!", data.message, "success");
      toggleSubcategories(catId);
    } else {
      Swal.fire("Error", data.message || "Approval failed.", "error");
    }
  }

  // ‚ùå Delete Subcategory
  async function deleteSubcategory(catId, subId) {
    const confirm = await Swal.fire({
      title: "Delete this subcategory?",
      text: "This action cannot be undone.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      confirmButtonText: "Yes, delete it",
    });

    if (!confirm.isConfirmed) return;

    const res = await fetch(`/admin/categories/${catId}/subcategories/delete/${subId}`, {
      method: "POST",
    });
    const data = await res.json();

    if (data.success) {
      Swal.fire("Deleted!", data.message, "success");
      toggleSubcategories(catId);
    } else {
      Swal.fire("Error", data.message || "Something went wrong.", "error");
    }
  }
</script>
