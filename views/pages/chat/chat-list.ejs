<!-- views/pages/chat/chat-list.ejs -->
 <div class="max-w-4xl mx-auto mt-10 bg-white shadow rounded-xl p-6">

  <h2 class="text-3xl font-bold text-green-700 mb-6 flex items-center gap-2">
    ðŸ’¬ Chats
  </h2>

  <!-- Empty state -->
  <% if (rooms.length === 0) { %>
    <div class="text-center text-gray-500 py-12">
      <p>No conversations yet.</p>
    </div>
  <% } %>

  <div class="divide-y">
    <% rooms.forEach(room => { %>

      <div class="py-4 flex items-center justify-between hover:bg-gray-50 rounded-lg px-2 transition cursor-pointer"
           onclick="openChat('<%= room._id %>')">

        <!-- USER Info -->
        <div class="flex items-center gap-3">
          <img 
    src="<%= room.otherUser.profile?.profilePic || '/default-user.png' %>"
    class="w-12 h-12 rounded-full border object-cover"
  />


          <div>
            <p class="font-semibold text-gray-800"><%= room.otherUser.fullName %></p>
            <p class="text-sm text-gray-500">Project: <%= room.projectTitle %></p>
          </div>
        </div>

        <!-- Unread badge -->
        <div class="text-right">
          <% if (room.unreadCount > 0) { %>
            <span class="bg-red-600 text-white text-xs px-3 py-1 rounded-full">
              <%= room.unreadCount %> new
            </span>
          <% } else { %>
            <span class="text-xs text-gray-400">No new messages</span>
          <% } %>
        </div>

      </div>

    <% }) %>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
const socket = io();

/* -------------------------------------------------
 âœ… Redirect to Chat Room
--------------------------------------------------*/
function openChat(roomId) {
  window.location.href = `/chat/room/${roomId}`;
}

/* -------------------------------------------------
 âœ… Real-time unread updates
   (server emits "roomUnreadUpdate")
--------------------------------------------------*/
socket.emit("joinNotificationChannel", "<%= userId %>");

socket.on("roomUnreadUpdate", (data) => {
  const { roomId, count } = data;

  // If you're on the chat-list page, update badge instantly:
  const row = document.querySelector(`[onclick="openChat('${roomId}')"]`);
  if (!row) return;

  const badgeContainer = row.querySelector("div.text-right");
  if (!badgeContainer) return;

  if (count > 0) {
    badgeContainer.innerHTML = `
      <span class="bg-red-600 text-white text-xs px-3 py-1 rounded-full">
        ${count} new
      </span>`;
  } else {
    badgeContainer.innerHTML = `<span class="text-xs text-gray-400">No new messages</span>`;
  }
});
</script>
