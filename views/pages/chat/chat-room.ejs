<!-- views/pages/chat/chat-room.ejs -->
<div class="max-w-5xl mx-auto mt-8">

  <!-- âœ… Header -->
  <div class="bg-white shadow p-4 rounded-lg flex items-center gap-4 mb-4">
    <img src="<%= otherUser.profile?.profilePic || '/default-user.png' %>"
     class="w-12 h-12 rounded-full border object-cover" />


    <div>
      <h2 class="text-xl font-bold"><%= otherUser.fullName %></h2>
      <p class="text-sm text-gray-500">Chat Room</p>
    </div>
  </div>

  <!-- âœ… Chat Box -->
  <div id="chatBox"
       class="bg-white shadow rounded-lg p-4 h-[60vh] overflow-y-auto space-y-3">

    <% messages.forEach(m => { %>
      <div class="<%= m.sender.toString() === userId.toString() 
                   ? 'text-right' 
                   : 'text-left' %>">

        <!-- âœ… File Message -->
        <% if (m.file) { %>
          <a href="<%= m.file %>" target="_blank"
             class="inline-block bg-blue-100 text-blue-800 px-3 py-2 rounded-lg text-sm font-medium">
            ðŸ“Ž File: <%= m.file.split('/').pop() %>
          </a>
        <% } %>

        <!-- âœ… Text Message -->
        <% if (m.content) { %>
          <p class="<%= m.sender.toString() === userId.toString()
                    ? 'bg-green-600 text-white'
                    : 'bg-gray-200 text-gray-800'
                  %> px-3 py-2 rounded-lg inline-block max-w-[70%]">
            <%= m.content %>
          </p>
        <% } %>

        <span class="text-[10px] text-gray-400 block mt-1">
          <%= new Date(m.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %>
        </span>
      </div>
    <% }) %>

  </div>

  <!-- âœ… Typing Indicator -->
  <div id="typingIndicator" class="text-gray-500 text-sm ml-2 mt-1 hidden">
    <%= otherUser.fullName %> is typing...
  </div>

  <!-- âœ… Input Section -->
  <div class="bg-white shadow rounded-lg p-3 mt-4 flex items-center gap-3">

    <!-- File Upload -->
    <button id="fileBtn"
            class="bg-gray-200 p-2 rounded hover:bg-gray-300 text-xl">
      ðŸ“Ž
    </button>
    <input type="file" id="chatFile" class="hidden" />

    <!-- Message Box -->
    <input id="chatInput"
           type="text"
           placeholder="Type a message..."
           class="flex-1 border p-2 rounded-lg focus:outline-none" />

    <!-- Send -->
    <button id="sendBtn"
            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold">
      Send
    </button>
  </div>
</div>


<!-- âœ… Socket.IO + SweetAlert -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
/* ---------------------------------------------
   INITIALIZE SOCKET
----------------------------------------------*/
const socket = io();
socket.emit("joinRoom", "<%= room._id %>");
socket.emit("joinUser", "<%= userId %>");

/* ---------------------------------------------
   DOM ELEMENTS
----------------------------------------------*/
const chatBox = document.getElementById("chatBox");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendBtn");
const fileBtn = document.getElementById("fileBtn");
const fileInput = document.getElementById("chatFile");
const typingIndicator = document.getElementById("typingIndicator");

function scrollBottom() {
  chatBox.scrollTop = chatBox.scrollHeight;
}
scrollBottom();

/* ---------------------------------------------
   SEND TEXT MESSAGE (AJAX)
----------------------------------------------*/
sendBtn.addEventListener("click", sendTextMessage);
chatInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") sendTextMessage();
  socket.emit("typing", { roomId: "<%= room._id %>" });
});

function sendTextMessage() {
  const content = chatInput.value.trim();
  if (!content) return;

  fetch("/chat/send", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      roomId: "<%= room._id %>",
      content
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      socket.emit("sendMessage", {
        roomId: "<%= room._id %>",
        receiverId: "<%= otherUser._id %>",
        message: data.data
      });
      chatInput.value = "";
    }
  });
}

/* ---------------------------------------------
   RECEIVE REAL-TIME MESSAGE
----------------------------------------------*/
socket.on("newMessage", (m) => {
  const mine = m.sender === "<%= userId %>";

  const html = `
    <div class="${mine ? 'text-right' : 'text-left'}">
      
      ${m.file ? `
        <a href="${m.file}" target="_blank"
           class="inline-block bg-blue-100 text-blue-800 px-3 py-2 rounded-lg text-sm font-medium">
           ðŸ“Ž File: ${m.file.split('/').pop()}
        </a>
      ` : ""}

      ${m.content ? `
        <p class="${mine
          ? 'bg-green-600 text-white'
          : 'bg-gray-200 text-gray-800'
        } px-3 py-2 rounded-lg inline-block max-w-[70%]">
          ${m.content}
        </p>
      ` : ""}

      <span class="text-[10px] text-gray-400 block mt-1">
        ${new Date(m.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
      </span>
    </div>
  `;

  chatBox.insertAdjacentHTML("beforeend", html);
  scrollBottom();
});

/* ---------------------------------------------
   FILE UPLOAD
----------------------------------------------*/
fileBtn.addEventListener("click", () => fileInput.click());

fileInput.addEventListener("change", async () => {
  if (!fileInput.files.length) return;

  const form = new FormData();
  form.append("file", fileInput.files[0]);
  form.append("roomId", "<%= room._id %>");

  Swal.fire({
    title: "Uploading...",
    allowOutsideClick: false,
    didOpen: () => Swal.showLoading()
  });

  const res = await fetch("/chat/upload", {
    method: "POST",
    body: form
  });

  const data = await res.json();
  Swal.close();

  if (!data.success) {
    return Swal.fire("Error", data.message, "error");
  }

  // âœ… DO NOT EMIT AGAIN â€” backend already emitted â€œnewMessageâ€
  // So we only clear file input.
  fileInput.value = "";
});


/* ---------------------------------------------
   TYPING INDICATOR
----------------------------------------------*/
socket.on("typing", () => {
  typingIndicator.classList.remove("hidden");
  setTimeout(() => typingIndicator.classList.add("hidden"), 1500);
});
</script>
