<!-- views/pages/freelancer/reviews.ejs -->
<div class="max-w-5xl mx-auto bg-white p-8 rounded-lg shadow-md">
  <h2 class="text-2xl font-bold text-purple-700 mb-6">ðŸŒŸ My Reviews & Ratings</h2>

  <!-- Average Rating -->
  <div class="bg-yellow-100 p-4 rounded-lg mb-6 text-center shadow">
    <h3 class="text-lg font-semibold text-yellow-700">Average Rating</h3>
    <p class="text-4xl font-bold text-yellow-600"><%= averageRating %> / 5</p>
  </div>

  <!-- Reviews List -->
  <div id="reviewsContainer" class="space-y-4">
    <% if (reviews.length === 0) { %>
      <p class="text-gray-500 text-center">No reviews yet. Keep delivering great work! ðŸ’ª</p>
    <% } else { %>
      <% reviews.forEach(r => { %>
        <div class="border p-4 rounded-lg shadow-sm hover:shadow-md transition">
          <div class="flex justify-between items-center mb-2">
            <h4 class="font-semibold text-gray-700"><%= r.client?.fullName %> â€¢ 
              <span class="text-yellow-500">
                <%= "â˜…".repeat(r.rating) %><%= "â˜†".repeat(5 - r.rating) %>
              </span>
            </h4>
            <p class="text-sm text-gray-400"><%= new Date(r.createdAt).toLocaleDateString() %></p>
          </div>

          <p class="text-gray-700 mb-2"><%= r.comment || "No comment provided." %></p>
          <p class="text-sm text-gray-600">Project: <strong><%= r.project?.title || 'N/A' %></strong></p>

          <!-- Freelancer Response -->
          <% if (r.freelancerResponse) { %>
            <div class="mt-3 p-3 bg-gray-50 border-l-4 border-purple-500 rounded">
              <p class="text-sm text-purple-700 font-semibold">Your Response:</p>
              <p class="text-gray-700"><%= r.freelancerResponse %></p>
            </div>
          <% } else { %>
            <form class="respondForm mt-3" data-id="<%= r._id %>">
              <textarea name="response" rows="2" class="border rounded p-2 w-full text-sm" placeholder="Write a response..."></textarea>
              <button type="submit" class="mt-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-1 rounded text-sm">
                ðŸ’¬ Respond
              </button>
            </form>
          <% } %>
        </div>
      <% }) %>
    <% } %>
  </div>
</div>

<!-- AJAX Handling -->
<script>
  // Submit response
  document.querySelectorAll(".respondForm").forEach(form => {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = form.dataset.id;
      const responseText = form.querySelector("textarea").value.trim();

      if (!responseText) return alert("Please write a response first.");

      const res = await fetch("/review/freelancer/reviews/respond", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ reviewId: id, response: responseText }),
      });

      const data = await res.json();
      if (data.success) {
        alert(data.message);
        refreshReviews();
      } else {
        alert("Failed to submit response.");
      }
    });
  });

  // Refresh reviews dynamically
  async function refreshReviews() {
    const res = await fetch("/review/freelancer/reviews/ajax");
    const data = await res.json();

    if (data.success) {
      const container = document.getElementById("reviewsContainer");
      container.innerHTML = data.reviews.map(r => `
        <div class="border p-4 rounded-lg shadow-sm">
          <div class="flex justify-between items-center mb-2">
            <h4 class="font-semibold text-gray-700">${r.client?.fullName || 'Client'} â€¢ 
              <span class="text-yellow-500">${"â˜…".repeat(r.rating)}${"â˜†".repeat(5 - r.rating)}</span>
            </h4>
            <p class="text-sm text-gray-400">${new Date(r.createdAt).toLocaleDateString()}</p>
          </div>
          <p class="text-gray-700 mb-2">${r.comment || "No comment provided."}</p>
          <p class="text-sm text-gray-600">Project: <strong>${r.project?.title || 'N/A'}</strong></p>
          ${r.freelancerResponse ? `
            <div class="mt-3 p-3 bg-gray-50 border-l-4 border-purple-500 rounded">
              <p class="text-sm text-purple-700 font-semibold">Your Response:</p>
              <p class="text-gray-700">${r.freelancerResponse}</p>
            </div>
          ` : ""}
        </div>
      `).join("");
    }
  }
</script>
