<!-- âœ… views/pages/client/payments-all.ejs -->

<div class="max-w-6xl mx-auto p-6">
  <h2 class="text-3xl font-bold text-green-700 mb-6">ğŸ’° All Project Payments</h2>

  <% if (projects.length === 0) { %>
    <div class="bg-white shadow p-10 text-center text-gray-600">
      No projects found.
    </div>
  <% } %>

  <!-- âœ… Group milestones by project -->
  <% projects.forEach(p => { %>

    <div class="bg-white shadow rounded-xl p-5 mb-8 border">
      <h3 class="text-xl font-bold text-gray-800 mb-3">
        ğŸ“ <%= p.title %>
      </h3>

      <div class="grid md:grid-cols-2 gap-4">

        <% milestones.filter(m => m.project._id.toString() === p._id.toString()).forEach(m => { %>
          <div class="border border-gray-100 rounded-lg p-4 shadow-sm">

            <h4 class="font-bold text-gray-800"><%= m.title %></h4>
            <p class="text-sm text-gray-600 mt-1"><%= m.description %></p>

            <div class="mt-3 text-sm text-gray-500">
              ğŸ’° Budget: <span class="font-semibold">â‚¹<%= m.amount %></span><br>
              â³ Status: <span class="font-semibold capitalize"><%= m.status %></span>
            </div>

            <div class="flex gap-2 mt-4">

              <!-- FUND MILESTONE -->
              <% if (m.status === "created") { %>
                <button
                  class="fundBtn bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm"
                  data-id="<%= m._id %>"
                  data-amount="<%= m.amount %>"
                >
                  ğŸ’³ Fund
                </button>
              <% } %>

              <!-- RELEASE PAYMENT -->
              <% if (m.status === "submitted") { %>
                <button
                  class="releaseBtn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-sm"
                  data-id="<%= m._id %>"
                  data-freelancer="<%= m.freelancer || p.hiredFreelancer %>"
                  data-amount="<%= m.amount %>"
                >
                  âœ… Release
                </button>
              <% } %>

            </div>

          </div>
        <% }) %>

      </div>
    </div>

  <% }) %>
</div>

<!-- âœ… Razorpay + SweetAlert -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // âœ… FUND event
  document.querySelectorAll(".fundBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      fundMilestone(btn.dataset.id, Number(btn.dataset.amount));
    });
  });

  // âœ… RELEASE event
  document.querySelectorAll(".releaseBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      releasePayment(
        btn.dataset.id,
        btn.dataset.freelancer,
        Number(btn.dataset.amount)
      );
    });
  });

});

/* âœ… FUND MILESTONE */
async function fundMilestone(milestoneId, amount) {
  try {
    const orderRes = await fetch("/payment/create-order", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ milestoneId, amount })
    });

    const orderData = await orderRes.json();
    if (!orderData.success)
      return Swal.fire("âŒ Error", orderData.message, "error");

    const rzp = new Razorpay({
      key: "<%= razorpayKey %>",
      amount: orderData.order.amount,
      currency: "INR",
      name: "Freelancer Marketplace",
      order_id: orderData.order.id,
      handler: async function (response) {
        const verifyRes = await fetch("/payment/verify", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_order_id: response.razorpay_order_id,
            razorpay_signature: response.razorpay_signature,
            milestoneId,
            amount
          })
        });

        const data = await verifyRes.json();
        Swal.fire(
          data.success ? "âœ… Payment Successful" : "âŒ Failed",
          data.message,
          data.success ? "success" : "error"
        );

        if (data.success) setTimeout(() => location.reload(), 800);
      }
    });

    rzp.open();

  } catch {
    Swal.fire("âŒ Error", "Something went wrong", "error");
  }
}

/* âœ… RELEASE PAYMENT */
async function releasePayment(milestoneId, freelancerId, amount) {
  const confirm = await Swal.fire({
    title: "Release Payment?",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "âœ… Release"
  });
  if (!confirm.isConfirmed) return;

  const res = await fetch("/payment/release", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ milestoneId, freelancerId, amount })
  });

  const data = await res.json();
  Swal.fire(
    data.success ? "âœ… Released" : "âŒ Error",
    data.message,
    data.success ? "success" : "error"
  );

  if (data.success) setTimeout(() => location.reload(), 800);
}
</script>
