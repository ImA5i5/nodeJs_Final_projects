<!-- views/pages/client/payments.ejs -->
<div class="max-w-5xl mx-auto p-6">
  <h2 class="text-3xl font-bold text-green-700 mb-6">ğŸ’° Project Payments</h2>

  <!-- Project Summary -->
  <div class="bg-white shadow rounded-lg p-5 mb-6">
    <h3 class="text-xl font-bold text-gray-700 mb-2">ğŸ“ <%= project.title %></h3>
    <p class="text-gray-600"><%= project.description.substring(0, 150) %>...</p>
  </div>

  <h3 class="text-xl font-semibold text-gray-700 mb-3">â± Milestones</h3>

  <div class="grid md:grid-cols-2 gap-4">
    <% milestones.forEach(m => { %>
      <div class="bg-white shadow rounded-lg p-4 border border-gray-100">
        <h4 class="font-bold text-gray-800"><%= m.title %></h4>
        <p class="text-sm text-gray-600 mt-1"><%= m.description %></p>

        <div class="mt-3 text-sm text-gray-500">
          ğŸ’° Budget: <span class="font-semibold">â‚¹<%= m.amount %></span><br>
          â³ Status: <span class="font-semibold capitalize"><%= m.status %></span>
        </div>

        <div class="flex gap-2 mt-4">

          <!-- FUND MILESTONE -->
          <% if (m.status === "created") { %>
            <button
              class="fundBtn bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm"
              data-id="<%= m._id %>"
              data-amount="<%= m.amount %>"
            >
              ğŸ’³ Fund via Razorpay
            </button>
          <% } %>

          <!-- RELEASE PAYMENT -->
          <% if (m.status === "submitted") { %>
            <button
              class="releaseBtn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-sm"
              data-id="<%= m._id %>"
              data-freelancer="<%= project.hiredFreelancer %>"
              data-amount="<%= m.amount %>"
            >
              âœ… Release Payment
            </button>
          <% } %>

        </div>
      </div>
    <% }) %>
  </div>
</div>

<!-- ğŸ”¥ Razorpay + SweetAlert -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
/* -------------------------------------------------------------
 âœ… EVENT LISTENERS (NO INLINE JS)
--------------------------------------------------------------*/
document.addEventListener("DOMContentLoaded", () => {

  // FUND button click
  document.querySelectorAll(".fundBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      const milestoneId = btn.dataset.id;
      const amount = Number(btn.dataset.amount);
      fundMilestone(milestoneId, amount);
    });
  });

  // RELEASE button click
  document.querySelectorAll(".releaseBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      const milestoneId = btn.dataset.id;
      const freelancerId = btn.dataset.freelancer;
      const amount = Number(btn.dataset.amount);
      releasePayment(milestoneId, freelancerId, amount);
    });
  });

});

/* -------------------------------------------------------------
 âœ… FUNCTION: Fund Milestone via Razorpay
--------------------------------------------------------------*/
async function fundMilestone(milestoneId, amount) {
  try {
    // Create Razorpay Order
    const orderRes = await fetch("/payment/create-order", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ milestoneId, amount })
    });

    const orderData = await orderRes.json();
    if (!orderData.success)
      return Swal.fire("âŒ Error", orderData.message, "error");

    const options = {
      key: "<%= razorpayKey %>",   // SAFE key from controller
      amount: orderData.order.amount,
      currency: "INR",
      name: "Freelancer Marketplace",
      description: "Milestone Funding",
      order_id: orderData.order.id,

      handler: async function (response) {
        // After Razorpay payment success â†’ verify
        const verifyRes = await fetch("/payment/verify", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_order_id: response.razorpay_order_id,
            razorpay_signature: response.razorpay_signature,
            milestoneId,
            amount
          })
        });

        const verifyData = await verifyRes.json();

        Swal.fire(
          verifyData.success ? "âœ… Payment Successful!" : "âŒ Verification Failed",
          verifyData.message,
          verifyData.success ? "success" : "error"
        );

        if (verifyData.success)
          setTimeout(() => location.reload(), 1000);
      }
    };

    const rzp = new Razorpay(options);
    rzp.open();

  } catch (err) {
    Swal.fire("âŒ Error", "Something went wrong!", "error");
  }
}

/* -------------------------------------------------------------
 âœ… FUNCTION: Release Payment to Freelancer
--------------------------------------------------------------*/
async function releasePayment(milestoneId, freelancerId, amount) {
  const confirm = await Swal.fire({
    title: "Release Payment?",
    text: "This will transfer funds to the freelancer's wallet.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "âœ… Release",
  });

  if (!confirm.isConfirmed) return;

  const res = await fetch("/payment/release", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ milestoneId, freelancerId, amount })
  });

  const data = await res.json();

  Swal.fire(
    data.success ? "âœ… Released" : "âŒ Error",
    data.message,
    data.success ? "success" : "error"
  );

  if (data.success)
    setTimeout(() => location.reload(), 1000);
}
</script>
