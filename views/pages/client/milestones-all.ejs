<!-- ‚úÖ views/pages/client/milestones-all.ejs -->

<div class="max-w-6xl mx-auto bg-white rounded-lg shadow-lg p-6 mt-10">

  <div class="flex items-center justify-between mb-6">
    <h2 class="text-3xl font-bold text-green-700 flex items-center gap-2">
      ‚è± All Milestones
    </h2>

    <a href="/client/post-project"
       class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold shadow-sm">
       ‚ûï New Project
    </a>
  </div>

  <% if (milestones.length > 0) { %>

    <div class="overflow-x-auto">
      <table class="min-w-full border border-gray-200 rounded-lg text-sm">
        <thead class="bg-green-700 text-white">
          <tr>
            <th class="p-3 text-left">Project</th>
            <th class="p-3 text-left">Milestone</th>
            <th class="p-3 text-center">Amount (‚Çπ)</th>
            <th class="p-3 text-center">Due Date</th>
            <th class="p-3 text-center">Status</th>
            <th class="p-3 text-center">Actions</th>
          </tr>
        </thead>

        <tbody>
          <% milestones.forEach(m => { %>
            <tr class="border-b hover:bg-gray-50 transition">

              <!-- ‚úÖ PROJECT NAME -->
              <td class="p-3 font-semibold text-gray-800">
                <%= m.project?.title || "N/A" %>
              </td>

              <!-- ‚úÖ TITLE -->
              <td class="p-3"><%= m.title %></td>

              <!-- ‚úÖ AMOUNT -->
              <td class="p-3 text-center">‚Çπ<%= m.amount %></td>

              <!-- ‚úÖ DUE DATE -->
              <td class="p-3 text-center">
                <%= m.dueDate ? new Date(m.dueDate).toLocaleDateString() : "‚Äî" %>
              </td>

              <!-- ‚úÖ STATUS BADGE -->
              <td class="p-3 text-center">
                <span class="px-3 py-1 rounded-full text-xs font-semibold
                  <%= m.status === 'created' ? 'bg-gray-200 text-gray-700' :
                       m.status === 'funded' ? 'bg-blue-100 text-blue-700' :
                       m.status === 'in-progress' ? 'bg-yellow-100 text-yellow-700' :
                       m.status === 'submitted' ? 'bg-purple-100 text-purple-700' :
                       m.status === 'released' ? 'bg-green-100 text-green-700' :
                       m.status === 'revision-requested' ? 'bg-red-100 text-red-700' :
                       'bg-gray-100 text-gray-600' %>">
                  <%= m.status %>
                </span>
              </td>

              <!-- ‚úÖ ACTIONS -->
              <td class="p-3 text-center flex justify-center gap-2 flex-wrap">

                <% if (m.status === 'created') { %>
                  <button onclick="fundMilestone('<%= m._id %>')"
                          class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs">
                    üí∞ Fund
                  </button>
                <% } %>

                <% if (m.status === 'submitted') { %>
                  <button onclick="viewDeliverables('<%= m._id %>')"
                          class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-xs">
                    üëÄ Review
                  </button>

                  <button onclick="approveMilestone('<%= m._id %>')"
                          class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs">
                    ‚úÖ Approve
                  </button>

                  <button onclick="requestChanges('<%= m._id %>')"
                          class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">
                    üîÅ Request Changes
                  </button>
                <% } %>

                <% if (m.status === 'released') { %>
                  <span class="text-green-600 text-sm font-semibold">üí∏ Released</span>
                <% } %>

              </td>

            </tr>
          <% }) %>
        </tbody>

      </table>
    </div>

  <% } else { %>

    <div class="text-center py-12 text-gray-500">
      <p>No milestones found.</p>
    </div>

  <% } %>

</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
async function fundMilestone(id) {
  const confirm = await Swal.fire({
    title: "Fund Milestone?",
    icon: "info",
    showCancelButton: true,
    confirmButtonText: "üí∞ Fund"
  });
  if (!confirm.isConfirmed) return;

  const res = await fetch(`/client/milestone/${id}/fund`, { method: "PUT" });
  const data = await res.json();

  Swal.fire(
    data.success ? "‚úÖ Funded!" : "‚ùå Error",
    data.message,
    data.success ? "success" : "error"
  );

  if (data.success) setTimeout(() => location.reload(), 1000);
}

async function viewDeliverables(id) {
  const res = await fetch(`/client/milestone/${id}/deliverables`);
  const data = await res.json();

  const html = data.deliverables?.length
    ? data.deliverables.map(f =>
        `<a href="${f.fileUrl}" target="_blank" class="block text-blue-600">${f.fileUrl.split('/').pop()}</a>`
      ).join('')
    : "No files uploaded yet.";

  Swal.fire({ title: "Deliverables", html });
}

async function approveMilestone(id) {
  const confirm = await Swal.fire({
    title: "Approve Milestone?",
    icon: "success",
    showCancelButton: true,
    confirmButtonText: "‚úÖ Approve"
  });
  if (!confirm.isConfirmed) return;

  const res = await fetch(`/client/milestone/${id}/approve`, { method: "PUT" });
  const data = await res.json();

  Swal.fire(
    data.success ? "‚úÖ Approved!" : "‚ùå Error",
    data.message,
    data.success ? "success" : "error"
  );

  if (data.success) setTimeout(() => location.reload(), 1000);
}

async function requestChanges(id) {
  const { value: feedback } = await Swal.fire({
    title: "Request Changes",
    input: "textarea",
    inputPlaceholder: "Enter feedback...",
    showCancelButton: true
  });
  if (!feedback) return;

  const res = await fetch(`/client/milestone/${id}/request-changes`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ feedback })
  });

  const data = await res.json();

  Swal.fire(
    data.success ? "üîÅ Changes Requested!" : "‚ùå Error",
    data.message,
    data.success ? "info" : "error"
  );

  if (data.success) setTimeout(() => location.reload(), 1000);
}
</script>
