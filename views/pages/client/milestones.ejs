<!-- views/pages/client/milestones.ejs -->
<div class="max-w-6xl mx-auto p-6 bg-white rounded-xl shadow mt-10">

  <!-- HEADER -->
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-2xl font-bold text-green-700 flex items-center gap-2">
      â± Milestones â€” <%= project.title %>
    </h2>

    <!-- Create Milestone Button -->
    <button id="btnCreate"
      class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
      â• Create Milestone
    </button>
  </div>

  <!-- EMPTY MESSAGE -->
  <% if (!milestones || milestones.length === 0) { %>
    <div class="text-center text-gray-500 py-10">
      No milestones yet. Create one above.
    </div>
  <% } %>

  <!-- MILESTONE LIST -->
  <div class="space-y-4">
    <% milestones.forEach(m => { %>
      <div id="ms-<%= m._id %>" 
        class="border rounded-lg p-4 shadow-sm bg-gray-50 flex justify-between items-start">

        <!-- LEFT INFO -->
        <div class="pr-4">
          <h4 class="text-lg font-semibold text-gray-800"><%= m.title %></h4>
          <p class="text-sm text-gray-600"><%= m.description || "No description" %></p>

          <div class="text-sm text-gray-500 mt-2 space-x-3">
            <span>ğŸ’° â‚¹<%= m.amount %></span>
            <span>ğŸ“… <%= m.dueDate ? new Date(m.dueDate).toLocaleDateString() : "â€”" %></span>

            <span class="px-2 py-0.5 rounded text-xs font-semibold
              <%= m.status === 'created' ? 'bg-gray-100 text-gray-700' :
                  m.status === 'funded' ? 'bg-blue-100 text-blue-700' :
                  m.status === 'in-progress' ? 'bg-yellow-100 text-yellow-700' :
                  m.status === 'submitted' ? 'bg-purple-100 text-purple-700' :
                  m.status === 'under-review' ? 'bg-indigo-100 text-indigo-700' :
                  m.status === 'revision-requested' ? 'bg-orange-100 text-orange-700' :
                  m.status === 'released' ? 'bg-green-100 text-green-700' :
                  m.status === 'completed' ? 'bg-emerald-100 text-emerald-700' :
                  m.status === 'disputed' ? 'bg-red-100 text-red-700' :
                  'bg-gray-100 text-gray-500' %>">
              <%= m.status %>
            </span>
          </div>

          <!-- DELIVERABLES -->
          <% if (m.deliverables?.length) { %>
            <div class="mt-3">
              <button 
                class="viewDeliverablesBtn text-blue-600 underline text-sm"
                data-files='<%- JSON.stringify(m.deliverables) %>'>
                ğŸ‘€ View Deliverables (<%= m.deliverables.length %>)
              </button>
            </div>
          <% } %>

          <!-- REVISION NOTE -->
          <% if (m.status === "revision-requested" && m.notes) { %>
            <p class="mt-2 text-sm text-orange-700">
              âœï¸ Revision note: <%= m.notes %>
            </p>
          <% } %>
        </div>

        <!-- ACTION BUTTONS -->
        <div class="flex flex-col gap-2 items-end min-w-[200px]">

          <% if (m.status === "created") { %>
            <button 
              class="fundBtn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-sm"
              data-id="<%= m._id %>"
              data-amount="<%= m.amount %>">
              ğŸ’³ Fund (Razorpay)
            </button>
          <% } %>

          <% if (["submitted", "under-review"].includes(m.status)) { %>
            <button 
              class="approveBtn bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm"
              data-id="<%= m._id %>">
              âœ… Approve & Release
            </button>

            <button 
              class="revisionBtn bg-orange-500 hover:bg-orange-600 text-white px-3 py-1.5 rounded text-sm"
              data-id="<%= m._id %>">
              âœï¸ Request Revision
            </button>
          <% } %>

          <% if (!["disputed", "released", "completed"].includes(m.status)) { %>
            <button 
              class="disputeBtn bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded text-sm"
              data-id="<%= m._id %>">
              ğŸš© Open Dispute
            </button>
          <% } %>

        </div>

      </div>
    <% }) %>
  </div>

</div>

<!-- âœ… Razorpay -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<!-- âœ… SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- âœ… Global Variables for JS -->
<script>
  window.RZP_KEY = "<%= razorpayKey || '' %>";
  window.PROJECT_ID = "<%= project._id %>";
</script>

<!-- âœ… External JS (NO inline JS) -->
<script src="/js/client/milestones.js"></script>
