<!-- ‚úÖ views/pages/client/milestones.ejs -->

<div class="max-w-6xl mx-auto p-6 bg-white rounded-xl shadow-md mt-10">
  <h2 class="text-3xl font-bold text-green-700 mb-6 flex items-center gap-2">
    ‚è± Milestones for <%= project.title %>
  </h2>

  <!-- ‚úÖ CREATE MILESTONE FORM -->
  <form id="createMilestoneForm" class="grid md:grid-cols-4 gap-3 mb-8">
    <input name="title" placeholder="Milestone title" required class="p-2 border rounded-md" />
    <input name="amount" type="number" placeholder="Amount (‚Çπ)" required class="p-2 border rounded-md" />
    <input name="dueDate" type="date" class="p-2 border rounded-md" />
    <textarea name="description" placeholder="Description" class="md:col-span-4 p-2 border rounded-md"></textarea>

    <button
      type="submit"
      class="md:col-span-4 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-md transition">
      ‚ûï Create Milestone
    </button>
  </form>

  <!-- ‚úÖ MILESTONE LIST -->
  <div id="milestoneList" class="space-y-4">

    <% if (milestones.length) { %>

      <% milestones.forEach(m => { %>
        <div
          class="border rounded-lg p-4 shadow-sm flex justify-between items-start hover:shadow-md transition"
          id="milestone-<%= m._id %>"
        >
          <div>
            <h4 class="text-lg font-semibold text-gray-800"><%= m.title %> ‚Äî ‚Çπ<%= m.amount %></h4>

            <p class="text-sm text-gray-600"><%= m.description || 'No description' %></p>

            <p class="text-xs text-gray-500 mt-1">
              Due: <%= m.dueDate ? new Date(m.dueDate).toLocaleDateString() : 'N/A' %>
            </p>

            <!-- ‚úÖ STATUS BADGE -->
            <span class="inline-block mt-2 px-3 py-1 text-xs font-semibold rounded-full
              <%= m.status === 'created' ? 'bg-yellow-100 text-yellow-700'
                : m.status === 'funded' ? 'bg-blue-100 text-blue-700'
                : m.status === 'submitted' ? 'bg-purple-100 text-purple-700'
                : m.status === 'revision-requested' ? 'bg-orange-100 text-orange-700'
                : (m.status === 'released' || m.status === 'completed') ? 'bg-green-100 text-green-700'
                : 'bg-gray-100 text-gray-700' %>">
              <%= m.status %>
            </span>
          </div>

          <!-- ‚úÖ ACTION BUTTONS -->
          <div class="flex flex-col gap-2 text-right">

            <!-- FUND -->
            <% if (m.status === 'created') { %>
              <button
                class="depositBtn bg-yellow-500 hover:bg-yellow-600 text-white text-sm px-3 py-1 rounded"
                data-id="<%= m._id %>">üí∞ Fund Escrow</button>
            <% } %>

            <!-- APPROVE / REQUEST REVISION -->
            <% if (m.status === 'submitted') { %>
              <button
                class="approveBtn bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-1 rounded"
                data-id="<%= m._id %>">‚úÖ Approve & Release</button>

              <button
                class="reviseBtn bg-orange-500 hover:bg-orange-600 text-white text-sm px-3 py-1 rounded"
                data-id="<%= m._id %>">‚úèÔ∏è Request Revision</button>
            <% } %>

            <% if (m.status === 'funded' || m.status === 'in-progress') { %>
              <span class="text-xs text-gray-500 italic">Freelancer working...</span>
            <% } %>

            <% if (m.status === 'released' || m.status === 'completed') { %>
              <span class="text-xs text-green-600 font-semibold">‚úÖ Done</span>
            <% } %>

            <% if (m.status === 'revision-requested') { %>
              <span class="text-xs text-orange-600 italic">Awaiting resubmission...</span>
            <% } %>

          </div>

        </div>
      <% }) %>

    <% } else { %>

      <div class="text-center py-10 text-gray-500">No milestones yet. Create one above.</div>

    <% } %>

  </div>
</div>


<!-- ‚úÖ SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>

/* ‚úÖ 1Ô∏è‚É£ CREATE MILESTONE */
document.getElementById("createMilestoneForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const data = Object.fromEntries(new FormData(e.target).entries());

  Swal.fire({ title: "Creating...", didOpen: () => Swal.showLoading() });

  const res = await fetch(`/milestone/project/<%= project._id %>/milestone`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });

  const json = await res.json();
  Swal.close();

  if (json.success)
    Swal.fire("‚úÖ Created", json.message, "success").then(() => location.reload());
  else
    Swal.fire("‚ùå Error", json.message, "error");
});

/* ‚úÖ 2Ô∏è‚É£ FUND MILESTONE */
document.querySelectorAll(".depositBtn").forEach(btn => {
  btn.addEventListener("click", async () => {
    const id = btn.dataset.id;

    const confirm = await Swal.fire({
      title: "Fund milestone?",
      icon: "question",
      showCancelButton: true,
      confirmButtonText: "üí∞ Fund"
    });

    if (!confirm.isConfirmed) return;

    Swal.fire({ title: "Processing...", didOpen: () => Swal.showLoading() });

    const res = await fetch(`/milestone/milestone/${id}/deposit`, { method: "POST" });
    const json = await res.json();
    Swal.close();

    if (json.success)
      Swal.fire("‚úÖ Funded", json.message, "success").then(() => location.reload());
    else
      Swal.fire("‚ùå Error", json.message, "error");
  });
});

/* ‚úÖ 3Ô∏è‚É£ APPROVE & RELEASE */
document.querySelectorAll(".approveBtn").forEach(btn => {
  btn.addEventListener("click", async () => {
    const id = btn.dataset.id;

    const confirm = await Swal.fire({
      title: "Approve milestone?",
      icon: "success",
      showCancelButton: true,
      confirmButtonText: "‚úÖ Approve"
    });

    if (!confirm.isConfirmed) return;

    Swal.fire({ title: "Releasing...", didOpen: () => Swal.showLoading() });

    const res = await fetch(`/milestone/milestone/${id}/review`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "approve" })
    });

    const json = await res.json();
    Swal.close();

    if (json.success)
      Swal.fire("‚úÖ Released", json.message, "success").then(() => location.reload());
    else
      Swal.fire("‚ùå Error", json.message, "error");
  });
});

/* ‚úÖ 4Ô∏è‚É£ REQUEST REVISION */
document.querySelectorAll(".reviseBtn").forEach(btn => {
  btn.addEventListener("click", async () => {
    const id = btn.dataset.id;

    const { value: note } = await Swal.fire({
      title: "Request Revision",
      input: "textarea",
      inputPlaceholder: "Describe needed changes...",
      showCancelButton: true
    });

    if (!note) return;

    Swal.fire({ title: "Sending...", didOpen: () => Swal.showLoading() });

    const res = await fetch(`/milestone/milestone/${id}/review`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "request_revision", note })
    });

    const json = await res.json();
    Swal.close();

    if (json.success)
      Swal.fire("‚úÖ Requested", json.message, "success").then(() => location.reload());
    else
      Swal.fire("‚ùå Error", json.message, "error");
  });
});
</script>
