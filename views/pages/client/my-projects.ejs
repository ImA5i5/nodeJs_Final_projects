<!-- views/pages/client/my-projects.ejs -->
<div class="max-w-6xl mx-auto bg-white shadow-md rounded-lg p-6 mt-10">

  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-3xl font-bold text-green-700 flex items-center gap-2">
      ğŸ“ My Projects
    </h2>
    <a href="/client/post-project"
       class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold shadow-sm">
      â• Post New Project
    </a>
  </div>

  <!-- Alert -->
  <div id="alertBox" class="hidden mb-4 p-3 rounded text-white text-center"></div>

  <% if (projects && projects.length > 0) { %>
    <div class="grid md:grid-cols-2 gap-6">

      <% projects.forEach((project) => { %>
      <div id="project-<%= project._id %>"
           class="border border-gray-200 rounded-xl p-5 shadow-sm hover:shadow-lg transition bg-gray-50">

        <!-- Title + Status -->
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-bold text-green-700"><%= project.title %></h3>

          <span class="px-3 py-1 rounded-full text-xs font-semibold
            <%= project.status === 'completed' ? 'bg-green-200 text-green-800' :
                project.status === 'in-progress' ? 'bg-blue-200 text-blue-800' :
                project.status === 'submitted' ? 'bg-purple-200 text-purple-800' :
                project.status === 'pending' ? 'bg-yellow-200 text-yellow-800' :
                project.status === 'disputed' ? 'bg-red-200 text-red-800' :
                'bg-gray-200 text-gray-700' %>">
            <%= project.status.charAt(0).toUpperCase() + project.status.slice(1) %>
          </span>
        </div>

        <% if (project.status === "completed") { %>
        <p class="text-green-700 text-sm mt-1">
          ğŸ‰ All milestones completed â€” Project is now <b>Completed</b>.
        </p>
        <% } %>

        <!-- Description -->
        <p class="text-gray-700 text-sm mt-2">
          <%= project.description.substring(0, 120) %>...
        </p>

        <!-- Meta -->
        <div class="mt-3 flex flex-wrap items-center gap-3 text-sm text-gray-600">
          <span>ğŸ’° <strong>Budget:</strong> â‚¹<%= project.budget %></span>
          <span>ğŸ•’ <strong>Duration:</strong> <%= project.duration || "N/A" %></span>
          <span>ğŸ’¼ <strong>Payment:</strong> <%= project.paymentType %></span>
        </div>

        <!-- Attachments -->
        <% if (project.attachments?.length) { %>
          <div class="mt-3">
            <h4 class="text-sm font-semibold text-gray-700 mb-1">ğŸ“ Attachments:</h4>
            <div class="flex flex-wrap gap-2">
              <% project.attachments.forEach((file) => { %>
                <a href="<%= file %>" target="_blank"
                   class="bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs px-3 py-1 rounded">
                  View File
                </a>
              <% }) %>
            </div>
          </div>
        <% } %>

        <!-- ACTIONS -->
        <div class="flex flex-wrap justify-end gap-3 mt-5">

          <!-- Milestones -->
          <a href="/milestone/project/<%= project._id %>/milestones"
             class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-sm">
            â± View Milestones
          </a>

          <!-- Submitted â†’ Review, Approve, Request -->
          <% if (project.status === "submitted") { %>
            <button onclick="reviewDeliverables('<%= project._id %>')"
              class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-sm">
              ğŸ‘€ Review Work
            </button>

            <button onclick="approveProject('<%= project._id %>')"
              class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm">
              âœ… Approve
            </button>

            <button onclick="requestChanges('<%= project._id %>')"
              class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1.5 rounded text-sm">
              ğŸ” Request Changes
            </button>
          <% } %>

          <!-- Payments -->
          <a href="/client/payments/<%= project._id %>"
             class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm">
            ğŸ’¸ Manage Payments
          </a>

          <!-- Edit -->
          <a href="/client/projects/<%= project._id %>/edit"
             class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1.5 rounded text-sm">
            âœï¸ Edit
          </a>

          <!-- Delete -->
          <button data-id="<%= project._id %>"
                  class="delete-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded text-sm">
            ğŸ—‘ï¸ Delete
          </button>

          <!-- Reviews -->
          <% if (project.status === "completed" && project.hiredFreelancer) { %>
            <% if (project.reviewed) { %>
              <a href="/review/view/<%= project._id %>"
                 class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1.5 rounded text-sm">
                âœ… View Review
              </a>
            <% } else { %>
              <a href="/review/write/<%= project._id %>"
                 class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm">
                â­ Leave Review
              </a>
            <% } %>
          <% } %>

        </div>
      </div>
      <% }) %>

    </div>
  <% } else { %>
    <div class="text-center py-12">
      <p class="text-gray-500 text-lg">No projects found.</p>
      <a href="/client/post-project"
         class="text-green-600 hover:underline font-semibold mt-2 inline-block">
        â• Post your first project
      </a>
    </div>
  <% } %>

</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
/* ===============================
   REVIEW DELIVERABLES
================================ */
async function reviewDeliverables(projectId) {
  const res = await fetch(`/project/client/${projectId}/deliverables`);
  const data = await res.json();

  if (!data.success) return Swal.fire("Error", data.message, "error");

  const files = data.deliverables.length
    ? data.deliverables.map(f =>
        `<a href="${f.fileUrl}" target="_blank" class="block text-blue-600">${f.fileUrl.split('/').pop()}</a>`
      ).join("")
    : "<p>No files uploaded yet.</p>";

  Swal.fire({ title: "ğŸ“¦ Deliverables", html: files });
}


/* ===============================
   APPROVE PROJECT
================================ */
async function approveProject(projectId) {
  const confirm = await Swal.fire({
    title: "Approve project?",
    text: "This will complete the project.",
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "âœ… Approve"
  });

  if (!confirm.isConfirmed) return;

  const res = await fetch(`/project/client/${projectId}/approve`, {
    method: "PUT"
  });

  const data = await res.json();

  Swal.fire(data.success ? "Completed!" : "Error", data.message);
  if (data.success) setTimeout(() => location.reload(), 900);
}


/* ===============================
   REQUEST CHANGES
================================ */
async function requestChanges(projectId) {
  const { value: feedback } = await Swal.fire({
    title: "Request Changes",
    input: "textarea",
    inputPlaceholder: "Describe needed revisions...",
    showCancelButton: true
  });

  if (feedback === undefined) return;

  const res = await fetch(`/project/client/${projectId}/revision`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ feedback })
  });

  const data = await res.json();

  Swal.fire(data.success ? "Requested!" : "Error", data.message);
  if (data.success) setTimeout(() => location.reload(), 900);
}


/* ===============================
   DELETE PROJECT
================================ */
document.querySelectorAll(".delete-btn").forEach(btn => {
  btn.addEventListener("click", async () => {
    if (!confirm("Delete this project?")) return;

    const id = btn.dataset.id;
    const res = await fetch(`/client/projects/${id}`, { method: "DELETE" });
    const data = await res.json();

    if (data.success) {
      document.getElementById(`project-${id}`).remove();
      showAlert("Deleted!", "bg-green-500");
    } else {
      showAlert("Delete failed", "bg-red-500");
    }
  });
});

function showAlert(msg, color) {
  const alertBox = document.getElementById("alertBox");
  alertBox.className = `block ${color} text-white p-3 rounded text-center mb-4`;
  alertBox.textContent = msg;
  setTimeout(() => alertBox.classList.add("hidden"), 2500);
}
</script>
