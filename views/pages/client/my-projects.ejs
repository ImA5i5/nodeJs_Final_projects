<!-- âœ… views/pages/client/my-projects.ejs -->
<div class="max-w-6xl mx-auto bg-white shadow-md rounded-lg p-6 mt-10">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-3xl font-bold text-green-700 flex items-center gap-2">
      ğŸ“ My Projects
    </h2>

    <a
      href="/client/post-project"
      class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold shadow-sm"
    >
      â• Post New Project
    </a>
  </div>

  <!-- Alert -->
  <div id="alertBox" class="hidden mb-4 p-3 rounded text-white text-center"></div>

  <% if (projects && projects.length > 0) { %>
    <div class="grid md:grid-cols-2 gap-6">
      <% projects.forEach((project) => { %>
        <div
          class="border border-gray-200 rounded-xl p-5 shadow-sm hover:shadow-lg transition-all duration-200 bg-gray-50 relative"
          id="project-<%= project._id %>"
        >
          <div class="flex justify-between items-center">
            <h3 class="text-xl font-bold text-green-700"><%= project.title %></h3>

            <!-- Status badge -->
            <span
              class="px-3 py-1 rounded-full text-xs font-semibold
              <%= project.status === 'completed' ? 'bg-green-200 text-green-800' :
                   project.status === 'in-progress' ? 'bg-blue-200 text-blue-800' :
                   project.status === 'submitted' ? 'bg-purple-200 text-purple-800' :
                   project.status === 'pending' ? 'bg-yellow-200 text-yellow-800' :
                   project.status === 'disputed' ? 'bg-red-200 text-red-800' :
                   'bg-gray-200 text-gray-700' %>">
              <%= project.status.charAt(0).toUpperCase() + project.status.slice(1) %>
            </span>
          </div>

          <p class="text-gray-700 text-sm mt-2">
            <%= project.description.substring(0, 120) %>...
          </p>

          <div class="mt-3 flex flex-wrap items-center gap-3 text-sm text-gray-600">
            <span>ğŸ’° <strong>Budget:</strong> â‚¹<%= project.budget %></span>
            <span>ğŸ•’ <strong>Duration:</strong> <%= project.duration || "N/A" %></span>
            <span>ğŸ’¼ <strong>Payment:</strong> <%= project.paymentType %></span>
          </div>

          <% if (project.attachments && project.attachments.length) { %>
            <div class="mt-3">
              <h4 class="text-sm font-semibold text-gray-700 mb-1">ğŸ“ Attachments:</h4>
              <div class="flex flex-wrap gap-2">
                <% project.attachments.forEach((file) => { %>
                  <a
                    href="<%= file %>"
                    target="_blank"
                    class="bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs px-3 py-1 rounded"
                  >
                    View File
                  </a>
                <% }) %>
              </div>
            </div>
          <% } %>

          <!-- Actions -->
          <div class="flex flex-wrap justify-end gap-3 mt-5">
            <!-- ğŸ‘€ Review / âœ… Approve / ğŸ” Request Changes -->
            <% if (project.status === 'submitted') { %>
              <button onclick="reviewDeliverables('<%= project._id %>')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-sm">
                ğŸ‘€ Review Work
              </button>
              <button onclick="approveProject('<%= project._id %>')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm">
                âœ… Approve
              </button>
              <button onclick="requestChanges('<%= project._id %>')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1.5 rounded text-sm">
                ğŸ” Request Changes
              </button>
            <% } %>

            <!-- âœ… Add Payment Button Here -->
      <a href="/client/payments/<%= project._id %>"
         class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm">
         ğŸ’¸ Manage Payments
      </a>

            <!-- Edit / Delete -->
            <a
              href="/client/projects/<%= project._id %>/edit"
              class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1.5 rounded text-sm"
            >
              âœï¸ Edit
            </a>

            <button
              class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded text-sm delete-btn"
              data-id="<%= project._id %>"
            >
              ğŸ—‘ï¸ Delete
            </button>

            <!-- â­ Review section -->
            <% if (project.status === 'completed' && project.hiredFreelancer) { %>
              <% if (project.reviewed) { %>
                <span class="text-gray-500 text-sm flex items-center gap-1">âœ… Reviewed</span>
              <% } else { %>
                <a
                  href="/client/review/<%= project._id %>"
                  class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm"
                >
                  â­ Leave Review
                </a>
              <% } %>
            <% } %>
          </div>
        </div>
      <% }) %>
    </div>
  <% } else { %>
    <div class="text-center py-12">
      <p class="text-gray-500 text-lg">No projects found.</p>
      <a
        href="/client/post-project"
        class="text-green-600 hover:underline font-semibold mt-2 inline-block"
      >
        â• Post your first project
      </a>
    </div>
  <% } %>
</div>

<!-- âœ… SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // ğŸ‘€ Review Deliverables
  async function reviewDeliverables(projectId) {
    const res = await fetch(`/project/client/${projectId}/deliverables`);
    const data = await res.json();

    if (data.success) {
      const files = data.deliverables.map(f =>
        `<a href="${f.fileUrl}" target="_blank" class="block text-blue-600 hover:underline">${f.fileUrl.split('/').pop()}</a>`
      ).join('') || "<p>No files uploaded yet.</p>";

      Swal.fire({
        title: "ğŸ“¦ Deliverables",
        html: files,
        confirmButtonText: "Close",
      });
    } else {
      Swal.fire("Error", data.message, "error");
    }
  }

  // âœ… Approve Project (Client Action)
  async function approveProject(projectId) {
    const confirm = await Swal.fire({
      title: "Approve this project?",
      text: "This will mark the project as completed and notify the freelancer.",
      icon: "question",
      showCancelButton: true,
      confirmButtonText: "âœ… Approve",
    });
    if (!confirm.isConfirmed) return;

    const res = await fetch(`/project/client/${projectId}/approve`, { method: "PUT" });
    const data = await res.json();

    Swal.fire(data.success ? "âœ… Approved!" : "âŒ Error", data.message);
    if (data.success) setTimeout(() => window.location.reload(), 1000);
  }

  // ğŸ” Request Changes
  async function requestChanges(projectId) {
    const { value: feedback } = await Swal.fire({
      title: "Request Changes",
      input: "textarea",
      inputLabel: "Optional Feedback for Freelancer",
      inputPlaceholder: "Describe what needs to be revised...",
      showCancelButton: true,
      confirmButtonText: "ğŸ” Send Request",
    });
    if (feedback === undefined) return;

    const res = await fetch(`/project/client/${projectId}/revision`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ feedback }),
    });

    const data = await res.json();
    Swal.fire(data.success ? "ğŸ” Revision Requested!" : "âŒ Error", data.message);
    if (data.success) setTimeout(() => window.location.reload(), 1000);
  }

  // ğŸ—‘ï¸ Delete Project
  const deleteButtons = document.querySelectorAll(".delete-btn");
  const alertBox = document.getElementById("alertBox");

  deleteButtons.forEach((btn) => {
    btn.addEventListener("click", async () => {
      if (!confirm("Are you sure you want to delete this project?")) return;
      const projectId = btn.dataset.id;

      try {
        const res = await fetch(`/client/projects/${projectId}`, { method: "DELETE" });
        const data = await res.json();
        if (res.ok && data.success) {
          document.getElementById(`project-${projectId}`).remove();
          showAlert("âœ… Project deleted successfully!", "bg-green-500");
        } else {
          showAlert(data.message || "âŒ Failed to delete project.", "bg-red-500");
        }
      } catch {
        showAlert("âš ï¸ Something went wrong.", "bg-red-500");
      }
    });
  });

  function showAlert(message, color) {
    alertBox.className = `block ${color} text-white p-3 rounded mb-4 text-center`;
    alertBox.textContent = message;
    setTimeout(() => (alertBox.className = "hidden"), 2500);
  }
</script>
